(function(a){function c(a){return a}function d(a,b){var c={};return c.metric=function(c){function q(a,d){var f=Math.min(l,Math.round((a-j)/k));m.splice(0,f),f=Math.min(l,f+e),b(c,new Date(d-f*k),d,k,function(b,c){if(b)return console.warn(b);for(var e=0,g=l-f,h=c.length;e<h;++e)m[e+g]=c[e];j=a,n.change.call(i,a,d)})}var i=new h(a,c),j=-Infinity,k=a.step(),l=a.size(),m=[],n=d3.dispatch("change"),o=0,p="beforechange.source-metric-"+ ++f;return i.valueAt=function(a){return m[a]},i.shift=function(e){return d(a,g(b,+e)).metric(c)},i.on=function(b,c){return arguments.length?(c==null&&n.on(b)!=null&&--o,c!=null&&n.on(b)==null&&++o,a.on(p,o>0?q:null),n.on(b,c),i):n.on(b)},i},c}function g(a,b){return function(c,d,e,f,g){a(c,new Date(+d+b),new Date(+e+b),f,g)}}function h(a,b){if(!(a instanceof p))throw new Error("invalid context");b+="",this.context=a,this.toString=function(){return b}}function j(a,b){function c(b,c){if(c instanceof h){if(b.context!==c.context)throw new Error("mismatch context")}else c=new k(b.context,c);h.call(this,b.context,b+" "+a+" "+c),this.left=b,this.right=c}var d=c.prototype=Object.create(h.prototype);return d.valueAt=function(a){return b(this.left.valueAt(a),this.right.valueAt(a))},d.shift=function(a){return new c(this.left.shift(a),this.right.shift(a))},d.on=function(a,b){return arguments.length<2?this.left.on(a):(this.left.on(a,b),this.right.on(a,b),this)},function(a){return new c(this,a)}}function k(a,b){h.call(this,a,b=+b),this.valueOf=function(){return b}}function n(a){return Math.floor(a/1e3)}function o(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").slice(1).map(function(a){return+a})}function p(){}var b=a.cubism={version:"0.0.1"},e=6,f=0,i=h.prototype;i.valueAt=function(){return NaN},i.extent=function(){var a=0,b=this.context.size(),c,d=Infinity,e=-Infinity;while(++a<b)c=this.valueAt(a),c<d&&(d=c),c>e&&(e=c);return[d,e]},i.on=function(a,b){return arguments.length<2?null:this},i.add=j("+",function(a,b){return a+b}),i.subtract=j("-",function(a,b){return a-b}),i.multiply=j("*",function(a,b){return a*b}),i.divide=j("/",function(a,b){return a/b}),i.shift=function(){return this},i.on=function(){return arguments.length<2?null:this};var l=k.prototype=Object.create(h.prototype);l.valueAt=function(){return+this},l.extent=function(){return[+this,+this]},p.prototype.cube=function(a){arguments.length||(a="");var b=d(this,function(b,c,d,e,f){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(b)+"&start="+m(c)+"&stop="+m(new Date(+d+e))+"&step="+e,function(a){if(!a)return f(new Error("unable to load data"));f(null,a.map(function(a){return a.value}))})});return b.toString=function(){return a},b};var m=d3.time.format.iso;p.prototype.graphite=function(a){arguments.length||(a="");var b=d(this,function(b,c,d,e,f){d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+b+",'')")+"&from="+n(c-2*e)+"&until="+n(d-1e3),function(a){if(!a)return f(new Error("unable to load data"));f(null,o(a))})});return b.toString=function(){return a},b},b.context=function(){var a=new p,b,c,d=4e3,e=1e3,f=d3.dispatch("beforechange","change");return setTimeout(function g(){var h=Date.now(),i=new Date(Math.floor((h-d-e)/b)*b),j=new Date(i-c*b),k=+i+b+d-h;k<e&&(k+=b),f.beforechange.call(a,j,i),setTimeout(function(){f.change.call(a,j,i)},e),setTimeout(g,k)},10),a.step=function(c){return arguments.length?(b=+c,a):b},a.size=function(b){return arguments.length?(c=+b,a):c},a.serverDelay=function(b){return arguments.length?(d=+b,a):d},a.clientDelay=function(b){return arguments.length?(e=+b,a):e},d3.rebind(a,f,"on"),a.step(1e4).size(1440)},p.prototype.constant=function(a){return new k(this,+a)},p.prototype.horizon=function(){function l(l){l.append("canvas").attr("width",b).attr("height",d),l.append("span").attr("class","title").text(h),l.append("span").attr("class","value"),l.each(function(h,l){function w(c,f){o.save(),o.clearRect(0,0,b,d);var g=r.extent(),h=t==null?g:t;e.domain([0,Math.max(-h[0],h[1])]),v=g.every(isFinite),n=r.valueAt(b-1),p.datum(n).text(isNaN(n)?null:i);for(var j=0;j<u;++j){o.fillStyle=s[u+j];var k=(j-u+1)*d;e.range([u*d+k,k]);for(var l=0,m=b,n;l<m;++l){var n=r.valueAt(l);if(n<=0)continue;o.fillRect(l,n=e(n),1,e(0)-n)}}a==="offset"&&(o.translate(0,d),o.scale(1,-1));for(var j=0;j<u;++j){o.fillStyle=s[u-1-j];var k=(j-u+1)*d;e.range([u*d+k,k]);for(var l=0,m=b,n;l<m;++l){var n=r.valueAt(l);if(n>=0)continue;o.fillRect(l,e(-n),1,e(0)-e(-n))}}o.restore()}var m=this,n=++q,o=d3.select(m).select("canvas").node().getContext("2d"),p=d3.select(m).select(".value"),r=typeof f=="function"?f.call(m,h,l):f,s=typeof j=="function"?j.call(m,h,l):j,t=typeof g=="function"?g.call(m,h,l):g,u=s.length>>1,v;r.on("change.horizon-"+n,function(a,b){w(a,b),v&&r.on("change.horizon-"+n,c)}),k.push(w)})}var a="offset",b=this.size(),d=40,e=d3.scale.linear().interpolate(d3.interpolateRound),f=c,g=null,h=c,i=d3.format(".2s"),j=["#08519c","#3182bd","#6baed6","#bdd7e7","#bae4b3","#74c476","#31a354","#006d2c"],k=[];return context.on("change.horizon-"+ ++q,function(a,b){k.forEach(function(c){c(a,b)})}),l.mode=function(b){return arguments.length?(a=b+"",l):a},l.height=function(a){return arguments.length?(d=+a,l):d},l.metric=function(a){return arguments.length?(f=a,l):f},l.extent=function(a){return arguments.length?(g=a,l):g},l.title=function(a){return arguments.length?(h=a,l):h},l.format=function(a){return arguments.length?(i=a,l):i},l.colors=function(a){return arguments.length?(j=a,l):j},l};var q=0;p.prototype.comparison=function(){function p(p){p.append("canvas").attr("width",a).attr("height",b),p.append("span").attr("class","title").text(h),p.append("span").attr("class","value primary"),p.append("span").attr("class","value change"),p.each(function(h,p){function C(c,e){u.save(),u.clearRect(0,0,a,b);var f=x.extent(),g=z.extent(),h=A==null?f:A;d.domain([0,h[1]]).range([b,0]),B=f.concat(g).every(isFinite);var o=x.valueAt(a-1),p=z.valueAt(a-1),q=(o-p)/p;v.datum(o).text(isNaN(o)?null:i),w.datum(q).text(isNaN(q)?null:j).attr("class","value change "+(q>0?"positive":q<0?"negative":"")),u.fillStyle=n;for(var r=0,s=a,t;r<s;++r){var C=d(x.valueAt(r));u.fillRect(r,C,1,b-C)}u.fillStyle=k[1];for(var r=0,s=a,t;r<s;++r){var C=d(x.valueAt(r)),D=d(z.valueAt(r));C<D&&u.fillRect(r,C,1,D-C)}u.fillStyle=k[0];for(var r=0,s=a,t;r<s;++r){var C=d(x.valueAt(r)),D=d(z.valueAt(r));C>D&&u.fillRect(r,D,1,C-D)}if(m>0){u.fillStyle=l;for(var r=0,s=a,t;r<s;++r){var C=d(x.valueAt(r));u.fillRect(r,C-m/2,1,m)}}u.restore()}function D(a,b){C(a,b),B&&(x.on("change.comparison-"+s,c),z.on("change.comparison-"+s,c))}var q=this,s=++r,t=d3.select(q),u=t.select("canvas").node().getContext("2d"),v=t.select(".value.primary"),w=t.select(".value.change"),x=typeof e=="function"?e.call(q,h,p):e,z=typeof f=="function"?f.call(q,h,p):f,A=typeof g=="function"?g.call(q,h,p):g,B;x.on("change.comparison-"+s,D),z.on("change.comparison-"+s,D),o.push(C)})}var a=this.size(),b=40,d=d3.scale.linear().interpolate(d3.interpolateRound),e=function(a){return a[0]},f=function(a){return a[1]},g=null,h=c,i=s,j=t,k=["#3182bd","#31a354"],l="#000000",m=2,n="rgba(0,0,0,.2)",o=[];return context.on("change.comparison-"+ ++r,function(a,b){o.forEach(function(c){c(a,b)})}),p.height=function(a){return arguments.length?(b=+a,p):b},p.primary=function(a){return arguments.length?(e=a,p):e},p.secondary=function(a){return arguments.length?(f=a,p):f},p.extent=function(a){return arguments.length?(g=a,p):g},p.title=function(a){return arguments.length?(h=a,p):h},p.formatPrimary=function(a){return arguments.length?(i=a,p):i},p.formatChange=function(a){return arguments.length?(j=a,p):j},p.colors=function(a){return arguments.length?(k=a,p):k},p.stroke=function(a){return arguments.length?(l=a,p):l},p.strokeWidth=function(a){return arguments.length?(m=a,p):m},p.fill=function(a){return arguments.length?(n=a,p):n},p};var r=0,s=d3.format(".2s"),t=d3.format("+.0%")})(this);