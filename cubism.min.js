(function(a){function c(a){return a}function e(a,b){var c={};return c.metric=function(c){function s(){var d=a.stop(),e;l||(l=n,e=!0),m=Math.round((a.start()-n)/o),b(c,l,d,o,function(b,c){if(b)return console.warn(b);c.forEach(function(a){q[Math.round((a[0]-n)/o)%p]=a[1]}),l=new Date(d-f*o),e&&a.refresh()})}var j=new h,k=++i,l,m,n=a.start(),o=a.step(),p=a.size(),q=new Array(p),r;setTimeout(s,10);var t=a.delay()-a.step()/2;return t>1e3&&(r=setTimeout(s,t)),a.on("change.metric-"+k,function(){r&&clearTimeout(r),r=setTimeout(s,a.step()/2)}),a.on("cancel.metric-"+k,function(){r=clearTimeout(r)}),j.size=function(){return p},j.extent=function(){return d3.extent(q)},j.valueAt=function(a){return q[(a+m)%p]},j.toString=function(){return c},j.shift=function(f,h){if(typeof f!="function"||typeof h!="function"){if(arguments.length<2)var i="milliseconds",j=f;else var i=f,j=h;f=d[i](+j),h=d[i](-j)}return e(a,g(b,f,h)).metric(c)},j},c}function g(a,b,c){return function(d,e,f,g,h){a(d,b(e),b(f),g,function(a,b){b&&(b=b.map(function(a){return[c(a[0]),a[1]]})),h(a,b)})}}function h(){}function j(a,b){return function c(d){var e=this;d instanceof h||(d=p(e.size(),d));if(e.size()!==d.size())throw new Error("different size!");var f=new h;return f.extent=function(){return d3.extent(d3.range(e.size()),f.valueAt)},f.valueAt=function(a){return b(e.valueAt(a),d.valueAt(a))},f.toString=function(){return e+" "+a+" "+d},f.size=e.size,f.shift=function(){return c.call(e.shift.apply(e,arguments),d.shift.apply(d,arguments))},f}}function m(a){return Math.floor(a/1e3)}function n(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").map(function(a,b){return[new Date(g+b*h),+a]}).slice(1)}function o(){}function p(a,b){b=+b,a=+a;var c=new h;return c.extent=function(){return[b,b]},c.valueAt=function(){return b},c.toString=function(){return b+""},c.size=function(){return a},c.shift=function(){return c},c}var b=a.cubism={version:"0.0.1"},d={milliseconds:function(a){return a=+a,function(b){return new Date(+b+a)}},second:function(a){return a*=1e3,function(b){return new Date(+b+a)}},minute:function(a){return a*=6e4,function(b){return new Date(+b+a)}},hour:function(a){return a=+a,function(b){return b=new Date(+b),b.setHours(b.getHours()+a),b}},day:function(a){return a=+a,function(b){return b=new Date(+b),b.setDate(b.getDate()+a),b}},month:function(a){return a=+a,function(b){return b=new Date(+b),b.setMonths(b.getMonths()+a),b}},year:function(a){return a=+a,function(b){return b=new Date(+b),b.setFullYear(b.getFullYear()+a),b}}},f=6,i=0;h.prototype.add=j("+",function(a,b){return a+b}),h.prototype.subtract=j("-",function(a,b){return a-b}),h.prototype.multiply=j("*",function(a,b){return a*b}),h.prototype.divide=j("/",function(a,b){return a/b}),o.prototype.cube=function(a){arguments.length||(a="");var b=e(this,function(b,c,d,e,f){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(b)+"&start="+k(c)+"&stop="+k(d)+"&step="+e,function(a){if(!a)return f(new Error("unable to load data"));f(null,a.map(function(a){return[l(a.time),a.value]}))})});return b.toString=function(){return a},b};var k=d3.time.format.iso,l=k.parse;o.prototype.graphite=function(a){arguments.length||(a="");var b=e(this,function(b,c,d,e,f){d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+b+",'')")+"&from="+m(c-2*e)+"&until="+m(d-1e3),function(a){if(!a)return f(new Error("unable to load data"));f(null,n(a))})});return b.toString=function(){return a},b},b.context=function(){function i(){j(),k()}function j(){h=0,l(),f.change.call(a)}function k(){g=setTimeout(i,a.delay())}function l(){var f=Date.now();return c=new Date(Math.floor(f/d)*d),b=new Date(c-e*d),a}var a=new o,b=new Date(NaN),c=new Date(NaN),d,e,f=d3.dispatch("change","cancel"),g,h;return setTimeout(k,10),a.start=function(){return b},a.stop=function(){return c},a.delay=function(){return+c+d-Date.now()},a.step=function(a){if(!arguments.length)return d;if(g)throw new Error("step cannot be changed mid-flight");return d=+a,l()},a.size=function(a){if(!arguments.length)return e;if(g)throw new Error("size cannot be changed mid-flight");return e=+a,l()},a.cancel=function(){return g&&(g=clearTimeout(g),f.cancel.call(a)),a},a.timeAt=function(a){return new Date(+b+a*d)},a.refresh=function(){return g&&!h&&(h=setTimeout(j,250)),a},d3.rebind(a,f,"on"),a.step(1e4).size(1440)},o.prototype.constant=function(a){return p(this.size(),a)},o.prototype.horizon=function(){function i(c){c.each(function(c,i){var j=d3.select(this),k=j.select("canvas"),l=j.select(".title"),m=j.select(".value"),n=typeof e=="function"?e.call(this,c,i):e,o=typeof f=="function"?f.call(this,c,i):f,p=typeof g=="function"?g.call(this,c,i):g;k.empty()&&(k=j.append("canvas").attr("width",b).attr("height",d),l=j.append("span").attr("class","title"),m=j.append("span").attr("class","value")),o==null&&(o=n.extent());var q=d3.scale.linear().domain([0,Math.max(-o[0],o[1])]).rangeRound([d,0]),r=k.node().getContext("2d");r.clearRect(0,0,b,d),r.fillStyle="steelblue";for(var i=0,s=b,t;i<s;++i){var t=n.valueAt(i);if(t<=0)continue;r.fillRect(i,t=q(t),1,d-t)}r.fillStyle="brown";if(a=="offset")for(var i=0,s=b,t;i<s;++i){var t=n.valueAt(i);if(t>=0)continue;r.fillRect(i,0,1,d-q(-t))}else for(var i=0,s=b,t;i<s;++i){var t=n.valueAt(i);if(t>=0)continue;r.fillRect(i,t=q(-t),1,d-t)}l.text(p),m.datum(t).text(isNaN(t)?null:h)})}var a="offset",b=this.size(),d=40,e=c,f=null,g=c,h=d3.format(".2s");return i.mode=function(b){return arguments.length?(a=b+"",i):a},i.height=function(a){return arguments.length?(d=+a,i):d},i.metric=function(a){return arguments.length?(e=a,i):e},i.extent=function(a){return arguments.length?(f=a,i):f},i.title=function(a){return arguments.length?(g=a,i):g},i.format=function(a){return arguments.length?(h=a,i):h},i}})(this);