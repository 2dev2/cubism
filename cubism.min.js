(function(a){function c(a){return a}function d(a){var b={};return b.metric=function(b,c){function p(){var d=b.stop();i||(i=k),j=Math.round((b.start()-k)/l),a(c,i,d,l,function(a,b){if(a)return console.warn(a);b.forEach(function(a){n[Math.round((a[0]-k)/l)%m]=a[1]}),i=new Date(d-e*l)})}var d=new f,h=++g,i,j,k=b.start(),l=b.step(),m=b.size(),n=new Array(m),o;setTimeout(p,10);var q=b.delay()-b.step()/2;return q>1e3&&(o=setTimeout(p,q)),b.on("change.metric-"+h,function(){o&&clearTimeout(o),o=setTimeout(p,b.step()/2)}),b.on("cancel.metric-"+h,function(){o=clearTimeout(o)}),d.size=function(){return m},d.extent=function(){return d3.extent(n)},d.valueAt=function(a){return n[(a+j)%m]},d.toString=function(){return c},d},b}function f(){}function h(a){return Math.floor(a/1e3)}function i(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").map(function(a,b){return[new Date(g+b*h),+a]}).slice(1)}function j(){}function k(a,b){if(a.size()!==b.size())throw new Error("different size!");var c=new f;return c.extent=function(){return d3.extent(d3.range(a.size()),c.valueAt)},c.valueAt=function(c){return a.valueAt(c)+b.valueAt(c)},c.toString=function(){return a+" + "+b},c.size=a.size,c}function l(a,b){if(a.size()!==b.size())throw new Error("different size!");var c=new f;return c.extent=function(){return d3.extent(d3.range(a.size()),c.valueAt)},c.valueAt=function(c){return a.valueAt(c)-b.valueAt(c)},c.toString=function(){return a+" - "+b},c.size=a.size,c}function m(a,b){if(a.size()!==b.size())throw new Error("different size!");var c=new f;return c.extent=function(){return d3.extent(d3.range(a.size()),c.valueAt)},c.valueAt=function(c){return a.valueAt(c)*b.valueAt(c)},c.toString=function(){return a+" * "+b},c.size=a.size,c}function n(a,b){if(a.size()!==b.size())throw new Error("different size!");var c=new f;return c.extent=function(){return d3.extent(d3.range(a.size()),c.valueAt)},c.valueAt=function(c){return a.valueAt(c)/b.valueAt(c)},c.toString=function(){return a+" / "+b},c.size=a.size,c}function o(a,b){b=+b,a=+a;var c=new f;return c.extent=function(){return[b,b]},c.valueAt=function(){return b},c.toString=function(){return b+""},c.size=function(){return a},c}var b=a.cubism={version:"0.0.1"},e=6,g=0;b.cube=function(a){arguments.length||(a="");var b=d3.time.format.iso,c=d(function(c,d,e,f,g){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(c)+"&start="+b(d)+"&stop="+b(e)+"&step="+f,function(a){if(!a)return g(new Error("unable to load data"));g(null,a.map(function(a){return[b.parse(a.time),a.value]}))})});return c.toString=function(){return a},c},b.graphite=function(a){arguments.length||(a="");var b=d(function(b,c,d,e,f){d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+b+",'')")+"&from="+h(c-2*e)+"&until="+h(d-1e3),function(a){if(!a)return f(new Error("unable to load data"));f(null,i(a))})});return b.toString=function(){return a},b},b.context=function(){function h(){k(),f.change.call(a),i()}function i(){g=setTimeout(h,a.delay())}function k(){var f=Date.now();return c=new Date(Math.floor(f/d)*d),b=new Date(c-e*d),a}var a=new j,b=new Date(NaN),c=new Date(NaN),d,e,f=d3.dispatch("change","cancel"),g;return setTimeout(i,10),a.start=function(){return b},a.stop=function(){return c},a.delay=function(){return+c+d-Date.now()},a.step=function(a){if(!arguments.length)return d;if(g)throw new Error("step cannot be changed mid-flight");return d=+a,k()},a.size=function(a){if(!arguments.length)return e;if(g)throw new Error("size cannot be changed mid-flight");return e=+a,k()},a.shift=function(g){var h=new j;return h.start=function(){return new Date(+b+g)},h.stop=function(){return new Date(+c+g)},h.delay=a.delay,h.step=function(){return d},h.size=function(){return e},h.timeAt=function(a){return new Date(+b+a*d+g)},d3.rebind(h,f,"on")},a.cancel=function(){return g&&(g=clearTimeout(g),f.cancel.call(a)),a},a.timeAt=function(a){return new Date(+b+a*d)},d3.rebind(a,f,"on"),a.step(1e4).size(1440)},f.prototype.add=function(a){return k(this,a instanceof f?a:o(this.size(),a))},f.prototype.subtract=function(a){return l(this,a instanceof f?a:o(this.size(),a))},f.prototype.multiply=function(a){return m(this,a instanceof f?a:o(this.size(),a))},f.prototype.divide=function(a){return n(this,a instanceof f?a:o(this.size(),a))},j.prototype.constant=function(a){return o(this.size(),a)},j.prototype.horizon=function(){function h(c){c.each(function(c,h){var i=d3.select(this),j=i.select("canvas"),k=i.select(".title"),l=i.select(".value"),m=typeof e=="function"?e.call(this,c,h):e,n=typeof f=="function"?f.call(this,c,h):f;j.empty()&&(j=i.append("canvas").attr("width",b).attr("height",d),k=i.append("span").attr("class","title"),l=i.append("span").attr("class","value"));var o=d3.scale.linear().domain([0,Math.max(-m.extent()[0],m.extent()[1])]).rangeRound([d,0]),p=j.node().getContext("2d");p.clearRect(0,0,b,d),p.fillStyle="steelblue";for(var h=0,q=b,r;h<q;++h){var r=m.valueAt(h);if(r<=0)continue;p.fillRect(h,r=o(r),1,d-r)}p.fillStyle="brown";if(a=="offset")for(var h=0,q=b,r;h<q;++h){var r=m.valueAt(h);if(r>=0)continue;p.fillRect(h,0,1,d-o(-r))}else for(var h=0,q=b,r;h<q;++h){var r=m.valueAt(h);if(r>=0)continue;p.fillRect(h,r=o(-r),1,d-r)}k.text(n),l.datum(r).text(isNaN(r)?null:g)})}var a="offset",b=this.size(),d=40,e=c,f=c,g=d3.format(".2s");return h.mode=function(b){return arguments.length?(a=b+"",h):a},h.height=function(a){return arguments.length?(d=+a,h):d},h.metric=function(a){return arguments.length?(e=a,h):e},h.title=function(a){return arguments.length?(f=a,h):f},h.format=function(a){return arguments.length?(g=a,h):g},h}})(this);