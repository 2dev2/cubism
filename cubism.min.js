(function(a){function c(a){return a}function d(a,b){var c={};return c.metric=function(c){var i=new h(a,c),j=-Infinity,k=a.step(),l=a.size(),m=++f,n=[],o=d3.dispatch("change");return a.on("beforechange.source-metric-"+m,function(a,d){var f=Math.min(l,Math.round((a-j)/k));n.splice(0,f),f=Math.min(l,f+e),b(c,new Date(d-f*k),d,k,function(b,c){if(b)return console.warn(b);for(var e=0,g=l-f,h=c.length;e<h;++e)n[e+g]=c[e];j=a,o.change.call(i,a,d)})}),i.valueAt=function(a){return n[a]},i.shift=function(e){return d(a,g(b,+e)).metric(c)},d3.rebind(i,o,"on")},c}function g(a,b){return function(c,d,e,f,g){a(c,new Date(+d+b),new Date(+e+b),f,g)}}function h(a,b){if(!(a instanceof q))throw new Error("invalid context");b+="",this.context=a,this.toString=function(){return b}}function k(a,b){function c(b,c){function g(){f.change.apply(d,arguments)}var d=this,e=++j;if(c instanceof h){if(b.context!==c.context)throw new Error("mismatch context")}else c=new l(b.context,c);h.call(this,b.context,b+" "+a+" "+c),this.left=b,this.right=c;var f=d3.dispatch("change");b.on("change.metric-operator-"+e,g),c.on("change.metric-operator-"+e,g),d3.rebind(this,f,"on")}var d=c.prototype=Object.create(h.prototype);return d.valueAt=function(a){return b(this.left.valueAt(a),this.right.valueAt(a))},d.shift=function(a){return new c(this.left.shift(a),this.right.shift(a))},function(a){return new c(this,a)}}function l(a,b){h.call(this,a,b=+b),this.valueOf=function(){return b}}function o(a){return Math.floor(a/1e3)}function p(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").slice(1).map(function(a){return+a})}function q(){}var b=a.cubism={version:"0.0.1"},e=6,f=0,i=h.prototype;i.valueAt=function(){return NaN},i.extent=function(){var a=0,b=this.context.size(),c,d=Infinity,e=-Infinity;while(++a<b)c=this.valueAt(a),c<d&&(d=c),c>e&&(e=c);return[d,e]},i.on=function(a,b){return arguments.length<2?null:this},i.add=k("+",function(a,b){return a+b}),i.subtract=k("-",function(a,b){return a-b}),i.multiply=k("*",function(a,b){return a*b}),i.divide=k("/",function(a,b){return a/b}),i.shift=function(){return this},i.on=function(){return arguments.length<2?null:this};var j=0,m=l.prototype=Object.create(h.prototype);m.valueAt=function(){return+this},m.extent=function(){return[+this,+this]},q.prototype.cube=function(a){arguments.length||(a="");var b=d(this,function(b,c,d,e,f){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(b)+"&start="+n(c)+"&stop="+n(new Date(+d+e))+"&step="+e,function(a){if(!a)return f(new Error("unable to load data"));f(null,a.map(function(a){return a.value}))})});return b.toString=function(){return a},b};var n=d3.time.format.iso;q.prototype.graphite=function(a){arguments.length||(a="");var b=d(this,function(b,c,d,e,f){d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+b+",'')")+"&from="+o(c-2*e)+"&until="+o(d-1e3),function(a){if(!a)return f(new Error("unable to load data"));f(null,p(a))})});return b.toString=function(){return a},b},b.context=function(){var a=new q,b,c,d=4e3,e=1e3,f=d3.dispatch("beforechange","change");return setTimeout(function g(){var h=Date.now(),i=new Date(Math.floor((h-d-e)/b)*b),j=new Date(i-c*b);f.beforechange.call(a,j,i),setTimeout(function(){f.change.call(a,j,i)},e),setTimeout(g,+i+b+d-h)},10),a.step=function(c){return arguments.length?(b=+c,a):b},a.size=function(b){return arguments.length?(c=+b,a):c},a.serverDelay=function(b){return arguments.length?(d=+b,a):d},a.clientDelay=function(b){return arguments.length?(e=+b,a):e},d3.rebind(a,f,"on"),a.step(1e4).size(1440)},q.prototype.constant=function(a){return new l(this,+a)},q.prototype.horizon=function(){function m(c){c.append("canvas").attr("width",d).attr("height",e),c.append("span").attr("class","title").text(i),c.append("span").attr("class","value"),c.each(function(c,i){function t(b,c){n.save(),n.clearRect(0,0,d,e);var g=r==null?p.extent():r;f.domain([0,Math.max(-g[0],g[1])]),m=p.valueAt(d-1),o.datum(m).text(isNaN(m)?null:j);for(var h=0;h<s;++h){n.fillStyle=q[s+h];var i=(h-s+1)*e;f.range([s*e+i,i]);for(var k=0,l=d,m;k<l;++k){var m=p.valueAt(k);if(m<=0)continue;n.fillRect(k,m=f(m),1,f(0)-m)}}a==="offset"&&(n.translate(0,e),n.scale(1,-1));for(var h=0;h<s;++h){n.fillStyle=q[s-1-h];var i=(h-s+1)*e;f.range([s*e+i,i]);for(var k=0,l=d,m;k<l;++k){var m=p.valueAt(k);if(m>=0)continue;n.fillRect(k,f(-m),1,f(0)-f(-m))}}n.restore()}var m=this,n=d3.select(m).select("canvas").node().getContext("2d"),o=d3.select(m).select(".value"),p=typeof g=="function"?g.call(m,c,i):g,q=typeof k=="function"?k.call(m,c,i):k,r=typeof h=="function"?h.call(m,c,i):h,s=q.length>>1;p.on("change.horizon-"+b,function(a,c){t(a,c),isFinite(f.domain()[1])&&p.on("change.horizon-"+b,null)}),l.push(t)})}var a="offset",b=++r,d=this.size(),e=40,f=d3.scale.linear().interpolate(d3.interpolateRound),g=c,h=null,i=c,j=d3.format(".2s"),k=["#08519c","#3182bd","#6baed6","#bdd7e7","#bae4b3","#74c476","#31a354","#006d2c"],l=[];return context.on("change.horizon-"+b,function(a,b){l.forEach(function(c){c(a,b)})}),m.mode=function(b){return arguments.length?(a=b+"",m):a},m.height=function(a){return arguments.length?(e=+a,m):e},m.metric=function(a){return arguments.length?(g=a,m):g},m.extent=function(a){return arguments.length?(h=a,m):h},m.title=function(a){return arguments.length?(i=a,m):i},m.format=function(a){return arguments.length?(j=a,m):j},m.colors=function(a){return arguments.length?(k=a,m):k},m};var r=0;q.prototype.comparison=function(){function o(c){c.append("canvas").attr("width",b).attr("height",d),c.append("span").attr("class","title").text(i),c.append("span").attr("class","value primary"),c.append("span").attr("class","value change"),c.each(function(c,i){function x(a,c){q.save(),q.clearRect(0,0,b,d);var f=Math.abs((w==null?t.extent():w)[1]),g=Math.abs((w==null?u.extent():w)[1]);e.domain([0,Math.max(f,g)]),e.range([d,0]);var h=t.valueAt(b-1),i=u.valueAt(b-1),n=(h-i)/i;r.datum(h).text(isNaN(h)?null:j),s.datum(n).text(isNaN(n)?null:k).attr("class","value change "+(n>0?"positive":n<0?"negative":"")),q.globalAlpha=.1,q.fillStyle=l[1];for(var o=0,p=b,v;o<p;++o){var x=e(t.valueAt(o));q.fillRect(o,x,1,d-x)}q.globalAlpha=1,q.fillStyle=l[2];for(var o=0,p=b,v;o<p;++o){var x=e(t.valueAt(o)),z=e(u.valueAt(o));x<z&&q.fillRect(o,x,1,z-x)}q.fillStyle=l[0];for(var o=0,p=b,v;o<p;++o){var x=e(t.valueAt(o)),z=e(u.valueAt(o));x>z&&q.fillRect(o,z,1,x-z)}q.fillStyle=l[1];for(var o=0,p=b,v;o<p;++o){var x=e(t.valueAt(o));q.fillRect(o,x-m/2+.5,1,m)}q.restore()}function z(b,c){x(b,c),e.domain().every(isFinite)&&(t.on("change.comparison-"+a,null),u.on("change.comparison-"+a,null))}var o=this,p=d3.select(o),q=p.select("canvas").node().getContext("2d"),r=p.select(".value.primary"),s=p.select(".value.change"),t=typeof f=="function"?f.call(o,c,i):f,u=typeof g=="function"?g.call(o,c,i):g,v=typeof l=="function"?l.call(o,c,i):l,w=typeof h=="function"?h.call(o,c,i):h;t.on("change.comparison-"+a,z),u.on("change.comparison-"+a,z),n.push(x)})}var a=++s,b=this.size(),d=40,e=d3.scale.linear().interpolate(d3.interpolateRound),f=function(a){return a[0]},g=function(a){return a[1]},h=null,i=c,j=t,k=u,l=["#3182bd","#000000","#31a354"],m=3,n=[];return context.on("change.comparison-"+a,function(a,b){n.forEach(function(c){c(a,b)})}),o.height=function(a){return arguments.length?(d=+a,o):d},o.primary=function(a){return arguments.length?(f=a,o):f},o.secondary=function(a){return arguments.length?(g=a,o):g},o.extent=function(a){return arguments.length?(h=a,o):h},o.title=function(a){return arguments.length?(i=a,o):i},o.formatPrimary=function(a){return arguments.length?(j=a,o):j},o.formatChange=function(a){return arguments.length?(k=a,o):k},o.colors=function(a){return arguments.length?(l=a,o):l},o.strokeWidth=function(a){return arguments.length?(m=a,o):m},o};var s=0,t=d3.format(".2s"),u=d3.format("+.0%")})(this);