(function(a){function d(a){return a}function e(a,b){var d={};return d.metric=function(d){function s(a,c){var e=Math.min(m,Math.round((a-k)/l));if(!e||r)return;o=n.slice(e),r=!0,k=a,e=Math.min(m,e+f),b(d,new Date(c-e*l),c,l,function(a,b){r=!1;if(a)return console.warn(a);for(var d=0,f=m-e,g=b.length;d<g;++d)o[d+f]=b[d];p.change.call(i,k,c)})}function t(a,b){n=o}var i=new h(a,d),j=".source-metric-"+ ++c,k=-Infinity,l=a.step(),m=a.size(),n=[],o=n,p=d3.dispatch("change"),q=0,r;return i.valueAt=function(a){return n[a]},i.shift=function(c){return e(a,g(b,+c)).metric(d)},i.on=function(b,c){return arguments.length?(c==null&&p.on(b)!=null&&--q,c!=null&&p.on(b)==null&&++q,a.on("beforechange"+j,q>0?s:null),a.on("change"+j,q>0?t:null),p.on(b,c),i):p.on(b)},i},d}function g(a,b){return function(c,d,e,f,g){a(c,new Date(+d+b),new Date(+e+b),f,g)}}function h(a,b){if(!(a instanceof p))throw new Error("invalid context");b+="",this.context=a,this.toString=function(){return b}}function j(a,b){function c(b,c){if(c instanceof h){if(b.context!==c.context)throw new Error("mismatch context")}else c=new k(b.context,c);h.call(this,b.context,b+" "+a+" "+c),this.left=b,this.right=c}var d=c.prototype=Object.create(h.prototype);return d.valueAt=function(a){return b(this.left.valueAt(a),this.right.valueAt(a))},d.shift=function(a){return new c(this.left.shift(a),this.right.shift(a))},d.on=function(a,b){return arguments.length<2?this.left.on(a):(this.left.on(a,b),this.right.on(a,b),this)},function(a){return new c(this,a)}}function k(a,b){h.call(this,a,b=+b),this.valueOf=function(){return b}}function n(a){return Math.floor(a/1e3)}function o(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").slice(1).map(function(a){return+a})}function p(){}var b=a.cubism={version:"0.0.1"},c=0;b.option=function(a,b){var c=location.search.substring(1).split("&"),d=-1,e=c.length,f;while(++d<e)if((f=c[d].split("="))[0]==a)return decodeURIComponent(f[1]);return b};var f=6,i=h.prototype;i.valueAt=function(){return NaN},i.extent=function(){var a=0,b=this.context.size(),c,d=Infinity,e=-Infinity;while(++a<b)c=this.valueAt(a),c<d&&(d=c),c>e&&(e=c);return[d,e]},i.on=function(a,b){return arguments.length<2?null:this},i.add=j("+",function(a,b){return a+b}),i.subtract=j("-",function(a,b){return a-b}),i.multiply=j("*",function(a,b){return a*b}),i.divide=j("/",function(a,b){return a/b}),i.shift=function(){return this},i.on=function(){return arguments.length<2?null:this};var l=k.prototype=Object.create(h.prototype);l.valueAt=function(){return+this},l.extent=function(){return[+this,+this]},p.prototype.cube=function(a){arguments.length||(a="");var b=e(this,function(b,c,d,e,f){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(b)+"&start="+m(c)+"&stop="+m(d)+"&step="+e,function(a){if(!a)return f(new Error("unable to load data"));f(null,a.map(function(a){return a.value}))})});return b.toString=function(){return a},b};var m=d3.time.format.iso;p.prototype.graphite=function(a){arguments.length||(a="");var b=e(this,function(b,c,d,e,f){d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+b+",'')")+"&from="+n(c-2*e)+"&until="+n(d-1e3),function(a){if(!a)return f(new Error("unable to load data"));f(null,o(a))})});return b.find=function(b,c){d3.json(a+"/metrics/find?format=completer"+"&query="+encodeURIComponent(b),function(a){if(!a)return c(new Error("unable to find metrics"));c(null,a.metrics.map(function(a){return a.path}))})},b.toString=function(){return a},b},b.context=function(){function n(){var c=Date.now();return f=new Date(Math.floor((c-i-j)/b)*b),e=new Date(f-d*b),h=new Date(Math.floor((c-i)/b)*b),g=new Date(h-d*b),l.domain([e,f]),a}var a=new p,b=1e4,d=1440,e,f,g,h,i=5e3,j=5e3,k=d3.dispatch("beforechange","change","focus"),l=a.scale=d3.time.scale().range([0,d]),m;return setTimeout(function(){var c=+h+i-Date.now();c<j&&(c+=b),setTimeout(function n(){h=new Date(Math.floor((Date.now()-i)/b)*b),g=new Date(h-d*b),k.beforechange.call(a,g,h),setTimeout(function(){l.domain([e=g,f=h]),k.change.call(a,g,h),k.focus.call(a,m)},j),setTimeout(n,b)},c)},10),a.step=function(a){return arguments.length?(b=+a,n()):b},a.size=function(a){return arguments.length?(l.range([0,d=+a]),n()):d},a.serverDelay=function(a){return arguments.length?(i=+a,n()):i},a.clientDelay=function(a){return arguments.length?(j=+a,n()):j},a.focus=function(b){return k.focus.call(a,m=b),a},a.on=function(b,c){return arguments.length<2?k.on(b):(k.on(b,c),c!=null&&(/^beforechange(\.|$)/.test(b)&&c.call(a,g,h),/^change(\.|$)/.test(b)&&c.call(a,e,f),/^focus(\.|$)/.test(b)&&c.call(a,m)),a)},d3.select(window).on("keydown.context-"+ ++c,function(){switch(!d3.event.metaKey&&d3.event.keyCode){case 37:m==null&&(m=d-1),m>0&&a.focus(--m);break;case 39:m==null&&(m=d-2),m<d-1&&a.focus(++m);break;default:return}d3.event.preventDefault()}),n()},p.prototype.constant=function(a){return new k(this,+a)},p.prototype.horizon=function(){function o(o){o.on("mousemove.horizon",function(){a.focus(d3.mouse(this)[0])}).on("mouseout.horizon",function(){a.focus(null)}),o.append("canvas").attr("width",g).attr("height",h),o.append("span").attr("class","title").text(l),o.append("span").attr("class","value"),o.each(function(l,o){function B(c,d){var j=0,k=t.extent();A=k.every(isFinite),v!=null&&(k=v);var l=Math.max(k[0],k[1]);i.domain([0,l]);if(this===a){if(l==y){j=g-f;var m=(c-w)/x;if(m<g){var n=e.getContext("2d");n.clearRect(0,0,g,h),n.drawImage(r.canvas,m,0,g-m,h,0,0,g-m,h),r.clearRect(0,0,g,h),r.drawImage(n.canvas,0,0)}}y=l,w=c}r.clearRect(j,0,g-j,h);var o;for(var p=0;p<z;++p){r.fillStyle=u[z+p];var q=(p-z+1)*h;i.range([z*h+q,q]),q=i(0);for(var s=j,B=g,C;s<B;++s){C=t.valueAt(s);if(C<=0){o=!0;continue}r.fillRect(s,C=i(C),1,q-C)}}if(o){b==="offset"&&(r.save(),r.translate(0,h),r.scale(1,-1));for(var p=0;p<z;++p){r.fillStyle=u[z-1-p];var q=(p-z+1)*h;i.range([z*h+q,q]),q=i(0);for(var s=j,B=g,C;s<B;++s){C=t.valueAt(s);if(C>=0)continue;r.fillRect(s,i(-C),1,q-i(-C))}}b==="offset"&&r.restore()}}function C(a){a==null&&(a=g-1);var b=t.valueAt(a);s.datum(b).text(isNaN(b)?null:m)}var p=this,q=++c,r=d3.select(p).select("canvas").node().getContext("2d"),s=d3.select(p).select(".value"),t=typeof j=="function"?j.call(p,l,o):j,u=typeof n=="function"?n.call(p,l,o):n,v=typeof k=="function"?k.call(p,l,o):k,w=-Infinity,x=a.step(),y,z=u.length>>1,A;t.on("change.horizon-"+q,function(a,b){B(a,b),C(),A&&t.on("change.horizon-"+q,d)}),a.on("change.horizon-"+q,B),a.on("focus.horizon-"+q,C)})}var a=this,b="offset",e=document.createElement("canvas"),g=e.width=a.size(),h=e.height=30,i=d3.scale.linear().interpolate(d3.interpolateRound),j=d,k=null,l=d,m=d3.format(".2s"),n=["#08519c","#3182bd","#6baed6","#bdd7e7","#bae4b3","#74c476","#31a354","#006d2c"];return o.mode=function(a){return arguments.length?(b=a+"",o):b},o.height=function(a){return arguments.length?(e.height=h=+a,o):h},o.metric=function(a){return arguments.length?(j=a,o):j},o.scale=function(a){return arguments.length?(i=a,o):i},o.extent=function(a){return arguments.length?(k=a,o):k},o.title=function(a){return arguments.length?(l=a,o):l},o.format=function(a){return arguments.length?(m=a,o):m},o.colors=function(a){return arguments.length?(n=a,o):n},o},p.prototype.comparison=function(){function o(o){o.on("mousemove.comparison",function(){a.focus(d3.mouse(this)[0])}).on("mouseout.comparison",function(){a.focus(null)}),o.append("canvas").attr("width",b).attr("height",e),o.append("span").attr("class","title").text(j),o.append("span").attr("class","value primary"),o.append("span").attr("class","value change"),o.each(function(j,o){function z(a,c){s.save(),s.clearRect(0,0,b,e);var d=v.extent(),g=w.extent(),h=x==null?d:x;f.domain([0,h[1]]).range([e,0]),y=d.concat(g).every(isFinite),s.fillStyle=m[2];for(var i=0,j=b;i<j;++i){var k=f(v.valueAt(i)),l=f(w.valueAt(i));k<l&&s.fillRect(i&16777214,k,1,l-k)}s.fillStyle=m[0];for(i=0;i<j;++i){var k=f(v.valueAt(i)),l=f(w.valueAt(i));k>l&&s.fillRect(i&16777214,l,1,k-l)}s.fillStyle=m[3];for(i=0;i<j;++i){var k=f(v.valueAt(i)),l=f(w.valueAt(i));k<=l&&s.fillRect(i&16777214,k,1,n)}s.fillStyle=m[1];for(i=0;i<j;++i){var k=f(v.valueAt(i)),l=f(w.valueAt(i));k>l&&s.fillRect(i&16777214,k-n,1,n)}s.restore()}function A(a){a==null&&(a=b-1);var c=v.valueAt(a),d=w.valueAt(a),e=(c-d)/d;t.datum(c).text(isNaN(c)?null:k),u.datum(e).text(isNaN(e)?null:l).attr("class","value change "+(e>0?"positive":e<0?"negative":""))}function B(a,b){z(a,b),A(),y&&(v.on("change.comparison-"+q,d),w.on("change.comparison-"+q,d))}var p=this,q=++c,r=d3.select(p),s=r.select("canvas").node().getContext("2d"),t=r.select(".value.primary"),u=r.select(".value.change"),v=typeof g=="function"?g.call(p,j,o):g,w=typeof h=="function"?h.call(p,j,o):h,x=typeof i=="function"?i.call(p,j,o):i,y;v.on("change.comparison-"+q,B),w.on("change.comparison-"+q,B),a.on("change.comparison-"+q,z),a.on("focus.comparison-"+q,A)})}var a=this,b=a.size(),e=120,f=d3.scale.linear().interpolate(d3.interpolateRound),g=function(a){return a[0]},h=function(a){return a[1]},i=null,j=d,k=q,l=r,m=["#9ecae1","#3182bd","#a1d99b","#31a354"],n=1.5;return o.height=function(a){return arguments.length?(e=+a,o):e},o.primary=function(a){return arguments.length?(g=a,o):g},o.secondary=function(a){return arguments.length?(h=a,o):h},o.scale=function(a){return arguments.length?(f=a,o):f},o.extent=function(a){return arguments.length?(i=a,o):i},o.title=function(a){return arguments.length?(j=a,o):j},o.formatPrimary=function(a){return arguments.length?(k=a,o):k},o.formatChange=function(a){return arguments.length?(l=a,o):l},o.colors=function(a){return arguments.length?(m=a,o):m},o.strokeWidth=function(a){return arguments.length?(n=a,o):n},o};var q=d3.format(".2s"),r=d3.format("+.0%");p.prototype.axis=function(){function d(d){a.on("change.axis-"+ ++c,function(){d.call(b)})}var a=this,b=d3.svg.axis().scale(a.scale);return d3.rebind(d,b,"orient","ticks","tickSubdivide","tickSize","tickPadding","tickFormat")},p.prototype.rule=function(){function b(b){var d=b.append("div").attr("class","line").style("position","fixed").style("top",0).style("right",0).style("bottom",0).style("width","1px").style("pointer-events","none");a.on("focus.rule-"+ ++c,function(a){d.style("display",a==null?"none":null).style("left",function(){return this.parentNode.offsetLeft-window.scrollX+a+"px"})})}var a=this;return b}})(this);